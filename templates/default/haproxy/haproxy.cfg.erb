# This file was generated by chef-alfresco

# General Configurations: global, timeouts
<% node['haproxy']['general_config'].each do |line| -%>
<%= line %>
<% end -%>

# Default frontend
frontend default
bind <%= node['haproxy']['bind_ip'] %>:<%= node['haproxy']['port'] %>

# Redirects
<%= node['haproxy']['redirects'] %>

# ACLs
<% node['haproxy']['backends'].each do |backendName,backend| -%>
  <% if backend['path_reg'] -%>
    acl is_<%= backendName %> path_reg <%= backend['path_reg'] %>
  <% end -%>
  <% if backend['path_beg'] -%>
    acl is_<%= backendName %> path_beg <%= backend['path_beg'] %>
  <% end -%>
<% end -%>

# Use backends
<% node['haproxy']['backends'].each do |backendName,backend| -%>
  use_backend <%= backendName %> if is_<%= backendName %>
<% end -%>

# Default Backend
default_backend <%= node['haproxy']['default_backend'] %>

# Backends list

<% node['haproxy']['backends'].each do |backendName,backend| -%>
  # <%= backendName %> backend
  <% if backend['httpchk'] -%>
    option httpchk GET <%= backend['httpchk'] %>
  <% end -%>
  cookie JSESSIONID prefix
  <% backend['nodes'].each do |node| -%>
    server <%= node['id'] %> <%= node['ip'] %>:<%= backend['port'] %> check inter 5000
  <% end -%>
<% end -%>
