# This file was generated by chef-alfresco

# General Configurations: global, timeouts
<% node['haproxy']['general_config'].each do |line| -%>
<%= line %>
<% end -%>

# Default frontend
frontend default
bind <%= node['haproxy']['bind_ip'] %>:<%= node['haproxy']['port'] %>

# ACLs
<% node['haproxy']['backends'].each do |backendName,backend| -%>
  <% backend['acls'].each do |pathType,paths| -%>
    <% paths.each do |path| -%>
acl is_<%= backendName %> <%= pathType %> <%= path %>
    <% end -%>
  <% end -%>
<% end -%>

# Redirects
<% if node['haproxy']['redirects'] -%>
  <% node['haproxy']['redirects'].each do |redirect| -%>
<%= redirect %>
  <% end -%>
<% end -%>

# Use backends
<% node['haproxy']['backends'].each do |backendName,backend| -%>
use_backend <%= backendName %> if is_<%= backendName %>
<% end -%>

# Default Backend
default_backend <%= node['haproxy']['default_backend'] %>

# Backends list

<% node['haproxy']['backends'].each do |backendName,backend| -%>
# <%= backendName %> backend
backend <%= backendName %>
  <% if backend['httpchk'] -%>
option httpchk GET <%= backend['httpchk'] %>
  <% end -%>
cookie JSESSIONID prefix
  <% backend['nodes'].each do |nodeHost,nodeIp| -%>
server <%= nodeHost %> <%= nodeIp %>:<%= backend['port'] %> check inter 5000
  <% end -%>

<% end -%>
