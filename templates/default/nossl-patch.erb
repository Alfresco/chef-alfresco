#!/bin/bash

cd /tmp
mkdir alfresco-war-temp ; cd alfresco-war-temp
unzip <%= node['artifacts']['alfresco']['destination'] %>/alfresco.war >> /var/log/messages
mv WEB-INF/web.xml WEB-INF/web.xml.orig
sed 's/api\/solr/fakeurl/' WEB-INF/web.xml.orig >> WEB-INF/web.xml
yum install -y zip >> /var/log/messages
zip -r alfresco.war * >> /var/log/messages
chown tomcat:tomcat alfresco.war >> /var/log/messages
service tomcat-alfresco stop >> /var/log/messages
sleep 5
rm -rf <%= node['artifacts']['alfresco']['destination'] %>/alfresc* >> /var/log/messages
mv -f alfresco.war <%= node['artifacts']['alfresco']['destination'] %>/ >> /var/log/messages
cd .. ; rm -rf alfresco-war-temp >> /var/log/messages
